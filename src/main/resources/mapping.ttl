@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix schema: <http://schema.org/> .
@prefix mw: <http://tools.wmflabs.org/mw2sparql/ontology#> .
@prefix rr: <http://www.w3.org/ns/r2rml#> .


# {base_url} is replaced before loading by the wiki base URL like "https://en.wikipedia.org"
# {lang} is replaced by the wiki language code like "en"
# {db} is replaced by the database name like "enwiki_p"
# {site_id} is replaced by the site id like "enwiki"

[ # Page: main mapping
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:tableName "{db}.page"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:Page ;
        rr:template  "{base_url}/wiki/ns{page_namespace}:{page_title}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "page_id" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:pageId
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "page_namespace" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:pageNamespaceId
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "page_title" ;
            rr:termType rr:Literal ;
            rr:language "{lang}"
        ] ;
        rr:predicate schema:name
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/revision/{page_latest}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:pageLatestRevision
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "page_content_model" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:pageContentModelId
    ]
] .

[ #Page: redirect
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, page_namespace FROM {db}.page WHERE page_is_redirect = 1"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:RedirectPage ;
        rr:template  "{base_url}/wiki/ns{page_namespace}:{page_title}" ;
        rr:termType rr:IRI
    ]
] .

[ #Page: new
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, page_namespace FROM {db}.page WHERE page_is_new = 1"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:NewPage ;
        rr:template  "{base_url}/wiki/ns{page_namespace}:{page_title}" ;
        rr:termType rr:IRI
    ]
] .

[ # Revision: main mapping
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT rev_id, rev_comment, rev_user_text, rev_len, rev_content_model, rev_content_format FROM {db}.revision"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:Revision ;
        rr:template  "{base_url}/revision/{rev_id}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_id" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:revisionId
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_comment" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate schema:comment
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_user_text" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:revisionUserName
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_len" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate schema:contentSize
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_content_model" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:revisionContentModelId
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_content_format" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate schema:fileFormat
    ]
] .

[ #Revision: minor
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT rev_id FROM {db}.revision WHERE rev_minor_edit = 1"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:MinorRevision ;
        rr:template  "{base_url}/revision/{rev_id}" ;
        rr:termType rr:IRI
    ]
] .

[ # Revision to page
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT rev_id, page_namespace, page_title FROM {db}.page INNER JOIN {db}.revision ON page_id = rev_page"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:Revision ;
        rr:template  "{base_url}/revision/{rev_id}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/wiki/ns{page_namespace}:{page_title}" ;
           rr:termType rr:IRI
       ] ;
       rr:predicate mw:revisionOfPage
    ]
] .

[ #PageLinks
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, pl_title, page_namespace, pl_namespace FROM {db}.page INNER JOIN {db}.pagelinks ON page_id = pl_from"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:template  "{base_url}/wiki/ns{page_namespace}:{page_title}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/wiki/ns{pl_namespace}:{pl_title}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:internalLinkTo
    ] ;
] .

[ #TemplateLinks
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, page_namespace, tl_namespace, tl_title FROM {db}.page INNER JOIN {db}.templatelinks ON page_id = tl_from"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:template  "{base_url}/wiki/ns{page_namespace}:{page_title}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/wiki/ns{tl_namespace}:{tl_title}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:includesPage
    ] ;
] .

[ #CategoryLinks
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, page_namespace, cl_to, CASE WHEN cl_type IS NOT NULL THEN 14 ELSE 14 END AS cl_namespace FROM {db}.page INNER JOIN {db}.categorylinks ON page_id = cl_from"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:template  "{base_url}/wiki/ns{page_namespace}:{page_title}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/wiki/ns{cl_namespace}:{cl_to}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:inCategory
    ] ;
] .

[ #Redirections TODO: cross wiki redirects and fragments
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, page_namespace, rd_namespace, rd_title FROM {db}.page INNER JOIN {db}.redirect ON page_id = rd_from AND rd_interwiki = ''"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:template  "{base_url}/wiki/ns{page_namespace}:{page_title}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/wiki/ns{rd_namespace}:{rd_title}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:redirectsTo
    ] ;
] .
