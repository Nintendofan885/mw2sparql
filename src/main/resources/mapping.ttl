@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix schema: <http://schema.org/> .
@prefix mw: <http://tools.wmflabs.org/mw2sparql/ontology#> .
@prefix rr: <http://www.w3.org/ns/r2rml#> .


# {base_url} is replaced before loading by the wiki base URL like "https://en.wikipedia.org"
# {lang} is replaced by the wiki language code like "en"
# {db} is replaced by the database name like "enwiki_p"
# {usual_db} is replaced by the extra db containing the namespace table
# {site_id} is replaced by the site id like "enwiki"

[ # Page: main mapping
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_id, page_namespace, page_title, page_latest, page_content_model, ns_name FROM {db}.page, {usual_db}.{site_id}_ns_id2name WHERE ns_id = page_namespace"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:Page ;
        rr:template  "{base_url}/wiki/{ns_name}:{page_title}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "page_id" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:pageId
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "page_namespace" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:pageNamespaceId
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "page_title" ;
            rr:termType rr:Literal ;
            rr:language "{lang}"
        ] ;
        rr:predicate schema:name
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/w/index.php?oldid={page_latest}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:pageLatestRevision
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "page_content_model" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:pageContentModelId
    ]
] .

[ #Page: redirect
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, ns_name FROM {db}.page, {usual_db}.{site_id}_ns_id2name WHERE ns_id = page_namespace AND page_is_redirect = 1"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:RedirectPage ;
        rr:template  "{base_url}/wiki/{ns_name}:{page_title}" ;
        rr:termType rr:IRI
    ]
] .

[ #Page: new
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, ns_name FROM {db}.page, {usual_db}.{site_id}_ns_id2name WHERE ns_id = page_namespace AND page_is_new = 1"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:NewPage ;
        rr:template  "{base_url}/wiki/{ns_name}:{page_title}" ;
        rr:termType rr:IRI
    ]
] .

[ # Revision: main mapping
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT rev_id, rev_comment, rev_user_text, rev_len, rev_content_model, rev_content_format, ns_name, page_title FROM {db}.revision, {db}.page, {usual_db}.{site_id}_ns_id2name WHERE page_id = rev_page AND ns_id = page_namespace"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:Revision ;
        rr:template  "{base_url}/w/index.php?oldid={rev_id}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_id" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:revisionId
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/wiki/{ns_name}:{page_title}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:revisionOfPage
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_comment" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate schema:comment
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_user_text" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:revisionUserName
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_len" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate schema:contentSize
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_content_model" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate mw:revisionContentModelId
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:column "rev_content_format" ;
            rr:termType rr:Literal
        ] ;
        rr:predicate schema:fileFormat
    ]
] .

[ #Revision: minor
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT rev_id FROM {db}.revision WHERE rev_minor_edit = 1"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:class     mw:MinorRevision ;
        rr:template  "{base_url}/w/index.php?oldid={rev_id}" ;
        rr:termType rr:IRI
    ]
] .

[ #PageLinks
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, pl_title, from_ns.ns_name AS from_ns_name, to_ns.ns_name AS to_ns_name FROM {db}.pagelinks, {db}.page, {usual_db}.{site_id}_ns_id2name AS from_ns, {usual_db}.{site_id}_ns_id2name AS to_ns WHERE page_id = pl_from AND from_ns.ns_id = page_namespace AND to_ns.ns_id = pl_namespace"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:template  "{base_url}/wiki/{from_ns_name}:{page_title}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/wiki/{to_ns_name}:{pl_title}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:internalLinkTo
    ] ;
] .

[ #TemplateLinks
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, from_ns.ns_name AS from_ns_name, to_ns.ns_name AS to_ns_name, tl_title FROM {db}.templatelinks, {db}.page, {usual_db}.{site_id}_ns_id2name AS from_ns, {usual_db}.{site_id}_ns_id2name AS to_ns WHERE page_id = tl_from AND from_ns.ns_id = page_namespace AND to_ns.ns_id = tl_namespace"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:template  "{base_url}/wiki/{from_ns_name}:{page_title}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/wiki/{to_ns_name}:{tl_title}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:includesPage
    ] ;
] .

[ #CategoryLinks
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, from_ns.ns_name AS from_ns_name, to_ns.ns_name AS to_ns_name, cl_to FROM {db}.categorylinks, {db}.page, {usual_db}.{site_id}_ns_id2name AS from_ns, {usual_db}.{site_id}_ns_id2name AS to_ns WHERE page_id = cl_from AND from_ns.ns_id = page_namespace AND to_ns.ns_id = 14"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:template  "{base_url}/wiki/{from_ns_name}:{page_title}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/wiki/{to_ns_name}:{cl_to}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:inCategory
    ] ;
] .

[ #Redirections + TODO cross wiki redirects and fragments
    a rr:TriplesMap ;
    rr:logicalTable [
        a rr:R2RMLView ;
        rr:sqlQuery  "SELECT page_title, from_ns.ns_name AS from_ns_name, to_ns.ns_name AS to_ns_name, rd_title FROM {db}.redirect, {db}.page, {usual_db}.{site_id}_ns_id2name AS from_ns, {usual_db}.{site_id}_ns_id2name AS to_ns WHERE page_id = rd_from AND from_ns.ns_id = page_namespace AND to_ns.ns_id = rd_namespace AND rd_interwiki = ''"
    ] ;
    rr:subjectMap [
        a rr:SubjectMap , rr:TermMap ;
        rr:template  "{base_url}/wiki/{from_ns_name}:{page_title}" ;
        rr:termType rr:IRI
    ] ;
    rr:predicateObjectMap [
        a rr:PredicateObjectMap ;
        rr:objectMap [
            a rr:ObjectMap , rr:TermMap ;
            rr:template "{base_url}/wiki/{to_ns_name}:{rd_title}" ;
            rr:termType rr:IRI
        ] ;
        rr:predicate mw:redirectsTo
    ] ;
] .
